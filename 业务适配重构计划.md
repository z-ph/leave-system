# 业务适配重构计划

## 📋 重构背景

### 变更概述
1. **后端接口变化** - openapi.yaml 和 Api.ts 已更新，需要适配新接口
2. **人员架构调整** - 从简单角色制升级为层级审批制（普通员工→中心主任→分管副主任→部门正职）
3. **审批流程优化** - 批假接口不再需要手动指定下一审核人，改为后端自动判断
4. **新增功能需求** - 个人信息展示和审批人自动重定向

### 重构目标
- **适配新接口** - 更新所有API调用以匹配最新的接口定义
- **适配新架构** - 根据新的4层人员架构调整权限和审批流程
- **优化Hook封装** - 创建符合新业务逻辑的Hook
- **更新数据展示** - 根据新字段和流程调整UI展示
- **新增用户功能** - 完善个人信息展示和登录体验优化

## 🔍 需要适配的具体变更

### 1. API接口变更分析

#### 批假接口 (`POST /from/approve`)
**变更前：**
```typescript
interface ApproveDTO {
  formID?: number;
  status?: boolean;
  remark?: string;
  nextUserId?: number; // ❌ 需要手动指定
}
```

**变更后：**
```typescript
interface ApproveDTO {
  formID?: number;
  status?: boolean;
  remark?: string;
  // ✅ nextUserId 移除，后端自动判断
}
```

#### 角色管理接口 (`POST /admin`)
**变更前：** 可能支持更复杂的角色设置
**变更后：** 明确支持4层角色架构

#### 其他接口
- 需要检查所有接口的字段变更
- 更新响应数据类型处理

### 2. 人员架构变更

**变更前：**
```
系统管理员
├── 中心主任
└── 普通员工
```

**变更后：**
```
系统管理员
├── 部门领导
│   ├── 部门正职（主任）- 最终审批权
│   └── 分管副主任 - 中层审批权
└── 中心主任 - 基层审批权
    └── 普通员工
```

### 3. 审批流程变更

**1天请假：** 员工 → 中心主任 → 结束
**2-3天请假：** 员工 → 中心主任 → 分管副主任 → 结束
**4天以上请假：** 员工 → 中心主任 → 分管副主任 → 部门正职 → 结束

## 🚀 重构任务清单

### Phase 1: API接口适配 (高优先级)

#### 1.1 批假接口适配
- [ ] 更新 `src/pages/admin/Approvals.vue` 中的审批逻辑
- [ ] 移除 `nextUserId` 相关代码
- [ ] 简化审批表单，只保留 `status` 和 `remark` 字段
- [ ] 更新相关的Hook (`src/pages/admin/hooks/useApprovals.ts`)

#### 1.2 角色管理适配
- [ ] 更新 `src/auth/roles.ts` 中的角色定义
- [ ] 适配4层角色架构
- [ ] 更新权限检查逻辑
- [ ] 检查 `src/auth/useCurrentUserRole.ts` Hook

#### 1.3 用户信息展示适配
- [ ] 检查用户信息接口返回的字段变更
- [ ] 更新 `src/pages/common/My.vue` 个人信息页面
- [ ] 更新 `src/pages/admin/Admins.vue` 用户管理页面
- [ ] 适配新的角色字段显示

#### 1.4 微信登录适配
- [ ] 检查微信绑定相关接口变更
- [ ] 更新 `src/pages/common/hooks/useWechatOAuth.ts`
- [ ] 适配首次账号密码登录后的微信绑定流程
- [ ] 完善微信登录状态处理

#### 1.5 数据类型适配
- [ ] 检查所有使用API数据的组件
- [ ] 更新字段名称映射
- [ ] 处理可能的数据格式变更
- [ ] 添加新字段的展示逻辑

### Phase 1.5: 新增功能实现 (高优先级)

#### 1.5.1 个人信息展示功能
- [ ] **完善 `src/pages/common/My.vue` 个人信息页面**
  - [ ] 显示用户姓名（后台自动导入）
  - [ ] 显示所属中心/部门（后台自动导入）
  - [ ] 显示工号信息
  - [ ] 显示角色信息
  - [ ] 显示手机号码
  - [ ] 展示微信绑定状态
- [ ] **创建个人信息展示Hook**
  - [ ] `src/pages/common/hooks/usePersonalInfo.ts`
  - [ ] 处理用户信息数据获取和缓存
  - [ ] 处理微信绑定状态显示
  - [ ] 添加信息编辑功能（如果需要）
- [ ] **个人信息UI组件**
  - [ ] 创建个人信息卡片组件
  - [ ] 设计信息展示布局
  - [ ] 添加加载状态和错误处理
  - [ ] 支持信息刷新功能

#### 1.5.2 审批人自动重定向功能
- [ ] **登录后路由逻辑优化**
  - [ ] 更新 `src/router/index.ts` 路由守卫
  - [ ] 根据用户角色自动重定向
  - [ ] 审批人角色登录后重定向到审批首页
  - [ ] 普通用户登录后重定向到用户首页
- [ ] **角色重定向配置**
  - [ ] 定义不同角色的默认路由
  - [ ] 系统管理员 → `/admin`
  - [ ] 部门正职/分管副主任 → `/admin`
  - [ ] 中心主任 → `/admin`
  - [ ] 普通员工 → `/common`
- [ ] **重定向逻辑Hook**
  - [ ] 创建 `src/hooks/useAutoRedirect.ts`
  - [ ] 处理登录后的自动跳转
  - [ ] 支持首次登录的特殊处理
  - [ ] 添加重定向规则配置

#### 1.5.3 微信登录流程优化
- [ ] **首次登录绑定流程**
  - [ ] 检测首次账号密码登录
  - [ ] 引导用户绑定微信
  - [ ] 绑定成功后更新登录状态
  - [ ] 后续支持微信直接登录
- [ ] **微信登录状态管理**
  - [ ] 更新 `src/auth/userSession.ts`
  - [ ] 添加微信绑定状态字段
  - [ ] 处理微信登录和账号登录的切换
  - [ ] 完善登录状态持久化
- [ ] **登录方式UI优化**
  - [ ] 更新 `src/pages/common/Login.vue`
  - [ ] 显示当前登录方式
  - [ ] 提供微信绑定入口
  - [ ] 优化登录体验

#### 1.5.4 账号密码登录功能
- [ ] **登录页面改造**
  - [ ] 在 `src/pages/common/Login.vue` 中添加账号密码登录表单
  - [ ] 实现微信登录失败时的降级处理
  - [ ] 添加登录方式切换功能
  - [ ] 优化登录界面布局和交互
- [ ] **账号密码登录逻辑**
  - [ ] 调用 `POST /login` 接口进行账号密码验证
  - [ ] 处理登录成功后的token存储
  - [ ] 实现登录失败错误处理
  - [ ] 添加登录状态管理
- [ ] **微信绑定自动化**
  - [ ] 账号密码登录成功后自动调用微信绑定接口
  - [ ] 调用 `POST /wx` 接口绑定微信openid
  - [ ] 处理绑定成功/失败的反馈
  - [ ] 完善绑定后的状态更新
- [ ] **登录体验优化**
  - [ ] 实现智能登录方式选择
  - [ ] 添加加载状态和错误提示
  - [ ] 支持记住登录状态
  - [ ] 优化首次登录流程引导

### Phase 2: Hook封装优化 (高优先级)

#### 2.1 审批相关Hook重构
- [ ] 重构 `src/pages/admin/hooks/useApprovals.ts`
  - [ ] 移除 `nextUserId` 相关逻辑
  - [ ] 简化审批状态管理
  - [ ] 优化错误处理
  - [ ] 添加自动刷新逻辑

#### 2.2 用户角色Hook优化
- [ ] 重构 `src/auth/useCurrentUserRole.ts`
  - [ ] 支持4层角色判断
  - [ ] 优化权限检查函数
  - [ ] 添加审批权限判断
  - [ ] 支持角色层级判断

#### 2.3 表单提交Hook适配
- [ ] 更新 `src/pages/common/hooks/useSubmitForm.ts`
  - [ ] 检查请假表单字段变更
  - [ ] 适配新的审批流程预期
  - [ ] 优化提交后状态处理
  - [ ] 添加流程状态展示

#### 2.4 用户信息Hook更新
- [ ] 更新 `src/pages/common/hooks/useUserInfo.ts`
  - [ ] 适配新的用户信息字段
  - [ ] 更新角色展示逻辑
  - [ ] 处理权限相关字段
  - [ ] 优化缓存策略

#### 2.5 审核员列表Hook优化
- [ ] 更新 `src/pages/common/hooks/useGetAdminList.ts`
  - [ ] 支持按角色类型筛选
  - [ ] 展示层级关系
  - [ ] 适配新的角色数据结构

### Phase 3: 数据展示更新 (中优先级)

#### 3.1 审批列表页面
- [ ] 更新 `src/pages/admin/Approvals.vue`
  - [ ] 显示当前审批级别
  - [ ] 展示审批进度状态
  - [ ] 适配4层角色的审批权限
  - [ ] 优化筛选功能

#### 3.2 请假列表页面
- [ ] 更新 `src/pages/common/LeaveList.vue`
  - [ ] 显示详细的审批进度
  - [ ] 展示各级审批人信息
  - [ ] 适配新的状态字段
  - [ ] 优化时间轴展示

#### 3.3 用户管理页面
- [ ] 更新 `src/pages/admin/Admins.vue`
  - [ ] 支持角色层级展示
  - [ ] 显示审批权限级别
  - [ ] 适配角色筛选功能
  - [ ] 优化用户信息展示

#### 3.4 个人中心页面
- [ ] 更新 `src/pages/common/My.vue`
  - [ ] 显示当前角色和权限
  - [ ] 展示审批相关功能
  - [ ] 适配新的个人信息字段
  - [ ] 优化权限功能入口

### Phase 4: 常量和类型定义 (中优先级)

#### 4.1 角色常量更新
- [ ] 更新 `src/auth/roles.ts`
  - [ ] 定义4层角色枚举
  - [ ] 添加角色层级映射
  - [ ] 定义审批权限级别
  - [ ] 添加角色判断工具函数

#### 4.2 状态常量扩展
- [ ] 更新 `src/constants/formStatus.ts`
  - [ ] 添加新的审批状态
  - [ ] 定义审批级别状态
  - [ ] 扩展请假类型枚举
  - [ ] 添加状态映射关系

#### 4.3 类型定义补充
- [ ] 创建 `src/types/approval.ts`
  - [ ] 定义审批流程类型
  - [ ] 定义审批进度类型
  - [ ] 定义角色权限类型
  - [ ] 添加相关工具类型

### Phase 5: 路由和权限适配 (低优先级)

#### 5.1 路由守卫更新
- [ ] 更新 `src/router/index.ts`
  - [ ] 适配4层角色权限检查
  - [ ] 优化权限验证逻辑
  - [ ] 支持层级权限控制
  - [ ] 更新角色元数据

#### 5.2 页面访问控制
- [ ] 检查所有页面的权限控制
- [ ] 适配新的角色体系
- [ ] 优化功能入口显示
- [ ] 更新权限提示信息

#### 5.3 导航菜单更新
- [ ] 更新 `src/components/NavLayout.vue`
  - [ ] 根据角色显示不同菜单
  - [ ] 适配4层权限体系
  - [ ] 优化菜单权限控制
  - [ ] 添加角色标识

## 📁 需要修改的文件清单

### 🔴 高优先级修改

#### API调用相关
```
src/pages/admin/hooks/useApprovals.ts    - 移除nextUserId逻辑
src/pages/admin/Approvals.vue           - 更新审批表单
src/pages/common/hooks/useSubmitForm.ts - 适配新的提交流程
src/pages/common/Form.vue               - 更新表单字段
```

#### 角色权限相关
```
src/auth/roles.ts                       - 定义4层角色
src/auth/useCurrentUserRole.ts          - 更新角色判断
src/auth/userSession.ts                 - 适配用户信息
src/pages/common/hooks/useUserInfo.ts   - 更新用户信息处理
```

#### 数据展示相关
```
src/pages/common/LeaveList.vue          - 更新审批进度展示
src/pages/admin/Admins.vue              - 适配角色展示
src/pages/common/My.vue                 - 完善个人信息展示
src/pages/common/hooks/useGetAdminList.ts - 更新审核员列表
```

#### 新增功能相关
```
src/pages/common/hooks/usePersonalInfo.ts - 新建个人信息展示Hook
src/hooks/useAutoRedirect.ts            - 新建自动重定向Hook
src/pages/common/hooks/useWechatOAuth.ts - 适配微信登录流���
src/pages/common/hooks/useAccountLogin.ts - 新建账号密码登录Hook
src/router/index.ts                     - 更新路由守卫和重定向逻辑
src/pages/common/Login.vue              - 完整登录页面改造
src/auth/userSession.ts                 - 添加微信绑定状态和登录方式管理
```

### 🟡 中优先级修改

#### 常量和类型
```
src/constants/formStatus.ts             - 扩展状态定义
src/types/                             - 新增类型定义文件
src/api/                               - 适配新接口的封装层
```

#### 路由和权限
```
src/router/index.ts                     - 更新权限守卫
src/components/NavLayout.vue            - 适配权限控制
src/router/routes.ts                    - 更新路由元数据
```

### 🟢 低优先级修改

#### 样式和体验
```
src/style.css                          - 适配新组件样式
src/components/                        - 通用组件适配
```

## 🔧 具体实现方案

### 1. 角色枚举定义
```typescript
// src/auth/roles.ts
export enum UserRole {
  ADMIN = 'admin',                    // 系统管理员
  DEPARTMENT_DIRECTOR = 'department_director',  // 部门正职（主任）
  DEPUTY_DIRECTOR = 'deputy_director',          // 分管副主任
  CENTER_DIRECTOR = 'center_director',          // 中心主任
  EMPLOYEE = 'employee'                           // 普通员工
}

export const ROLE_HIERARCHY = {
  [UserRole.ADMIN]: 4,
  [UserRole.DEPARTMENT_DIRECTOR]: 3,
  [UserRole.DEPUTY_DIRECTOR]: 2,
  [UserRole.CENTER_DIRECTOR]: 1,
  [UserRole.EMPLOYEE]: 0,
};
```

### 2. 审批权限判断
```typescript
// src/auth/useCurrentUserRole.ts
export function useApprovalPermissions() {
  const { role } = useCurrentUserRole();

  const canApprove1Day = computed(() =>
    role.value === UserRole.CENTER_DIRECTOR
  );

  const canApprove2Days = computed(() =>
    role.value === UserRole.DEPUTY_DIRECTOR
  );

  const canApprove4Days = computed(() =>
    role.value === UserRole.DEPARTMENT_DIRECTOR
  );

  return {
    canApprove1Day,
    canApprove2Days,
    canApprove4Days,
  };
}
```

### 3. 审批流程状态
```typescript
// src/types/approval.ts
export interface ApprovalProgress {
  currentStep: number;
  totalSteps: number;
  currentApprover: string;
  nextApprover?: string;
  status: 'pending' | 'approved' | 'rejected';
}

export const APPROVAL_STEPS = {
  1: { name: '中心主任审批', role: UserRole.CENTER_DIRECTOR },
  2: { name: '分管副主任审批', role: UserRole.DEPUTY_DIRECTOR },
  3: { name: '部门正职审批', role: UserRole.DEPARTMENT_DIRECTOR },
};
```

### 4. 审批Hook重构
```typescript
// src/pages/admin/hooks/useApprovals.ts
export function useApprovals() {
  const { canApprove1Day, canApprove2Days, canApprove4Days } = useApprovalPermissions();

  const approveRequest = async (formId: number, status: boolean, remark?: string) => {
    // 简化的审批接口调用，不再需要nextUserId
    await api.from.approveCreate({
      formID: formId,
      status,
      remark,
    });

    // 刷新列表
    await refetch();
  };

  return {
    approveRequest,
    canApprove1Day,
    canApprove2Days,
    canApprove4Days,
  };
}
```

## ⏰ 时间估算

- **Phase 1**: 2-3天 (API接口适配)
- **Phase 1.5**: 3-4天 (新增功能实现)
  - 个人信息展示: 1-2天
  - 审批人自动重定向: 1天
  - 微信登录流程优化: 1天
  - 账号密码登录功能: 1天
- **Phase 2**: 2-3天 (Hook封装优化)
- **Phase 3**: 2-3天 (数据展示更新)
- **Phase 4**: 1-2天 (常量和类型定义)
- **Phase 5**: 1天 (路由和权限适配)

**总计**: 11-16天

## 🚨 风险评估

### 高风险
- **角色权限逻辑** - 涉及安全控制，需要仔细测试
- **审批流程变更** - 核心业务逻辑，影响用户体验

### 中风险
- **数据展示变更** - 可能影响用户理解
- **Hook重构** - 需要保持向后兼容

### 低风险
- **常量定义更新** - 主要是类型安全
- **样式适配** - 不影响核心功能

## 📋 验收标准

### 功能验收
- [ ] 所有API调用正常，无报错
- [ ] 4层角色权限控制正确
- [ ] 审批流程按天数自动判断
- [ ] 用户信息正确展示

### 用户体验验收
- [ ] 审批操作简化，用户体验提升
- [ ] 权限界面根据角色正确显示
- [ ] 审批进度展示清晰
- [ ] 错误提示友好

### 技术验收
- [ ] TypeScript编译无错误
- [ ] 代码规范检查通过
- [ ] 性能无明显下降
- [ ] 兼容性测试通过

---

**注意：** 本次重构重点是**业务适配**而非技术重构，所有变更都应该围绕后端接口和业务架构的变化进行。确保在适配新功能的同时，保持现有功能的稳定性。